<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini 任務執行器</title>

  <script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap/bootstrap.min.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap/bootstrap.min.css') }}" />
  <style>
    /* 保持自訂日誌樣式，因為它們是獨特的 */
    #log-container {
      white-space: pre-wrap;
      word-wrap: break-word;
      background-color: #1e293b;
      color: #f1f5f9;
      border-radius: 0.5rem;
      padding: 1rem;
      height: 60vh;
      overflow-y: auto;
      /* font-family: "Courier New", Courier, monospace; */
      text-align: left;
    }

    /* 自訂日誌文字顏色，不與 Bootstrap 衝突 */
    .log-item {
      text-align: left;
    }

    .log-status {
      text-align: left;
      color: #67e8f9;
    }

    .log-error {
      color: #f87171;
      font-weight: bold;
      text-align: left;
    }

    .log-data {
      color: #e5e7eb;
      text-align: left;
    }

    .log-done {
      color: #4ade80;
      font-weight: bold;
      text-align: left;
    }
  </style>

  <script>
    var jsondata_from_server = {{ jsondata | tojson | safe }}

    $(document).ready(function () {
      var data = jsondata_from_server;

      $('#btnNew').click(function () {
        location.href = "/detail?id=''";
      });

      // 初始化 DataTable
      var dataTable = $('#table1').DataTable({
        data: data,
        columns: [
          { data: 'id' },
          {
            data: 'name',
            render: function (data, type, row) {
              const url = `/detail?id=${row.id}`;
              return `<a href="${url}">${data}</a>`;
            }
          },
          {
            data: null,
            render: function (data, type, row) {
              return $("<div/>").append($("<button/>", { class: "btn btn-primary btnRun", text: "執行" })).html();
            }
          }
        ],
        language: {
          "sProcessing": "處理中...",
          "sLengthMenu": "顯示 _MENU_ 筆結果",
          "sZeroRecords": "沒有符合的結果",
          "sInfo": "顯示第 _START_ 至 _END_ 筆結果，共 _TOTAL_ 筆",
          "sInfoEmpty": "顯示第 0 至 0 筆結果，共 0 筆",
          "sInfoFiltered": "(從 _MAX_ 筆結果中過濾)",
          "sInfoPostFix": "",
          "sSearch": "搜尋:",
          "sUrl": "",
          "oPaginate": {
            "sFirst": "第一頁",
            "sPrevious": "上一頁",
            "sNext": "下一頁",
            "sLast": "最後一頁"
          }
        },
        pageLength: 10,
        order: [[0, 'asc']],
        dom: 't<"text-right"i><"text-center"p>', // 't' 代表 table, 'i' 代表 info, 'p' 代表 pagination
        searching: false,
        paging: true,
        info: true,
        lengthMenu: false,
        autoWidth: true,
        responsive: true,
      });

      $("#table1").on('click', ".btnRun", async function (e) {
        var id = dataTable.row($(this).parents('tr')).data().id;

        const $logContainer = $('#log-container');
        $logContainer.empty();

        const $submitBtn = $('.btnRun');
        $submitBtn.prop('disabled', true).text('執行中...');

        try {
          const response = await fetch(`/runbyid?id=${id}`, {
            method: "POST"
          });

          if (!response.ok) {
            throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              break;
            }

            buffer += decoder.decode(value, { stream: true });

            let boundary = buffer.indexOf("\n\n");
            while (boundary !== -1) {
              const messageString = buffer.substring(0, boundary);
              buffer = buffer.substring(boundary + 2);

              if (messageString.startsWith("data: ")) {
                const jsonString = messageString.substring(6);
                try {
                  const data = JSON.parse(jsonString);

                  const timestamp = new Date().toLocaleTimeString();
                  const logEntryHtml = `
                    <span class="log-item text-muted">[${timestamp}]</span>
                    <span class="log-${data.type}">${data.content}</span>
                  `;

                  const $logEntry = $('<div>').html(logEntryHtml);
                  $logContainer.append($logEntry);
                  $logContainer.scrollTop($logContainer[0].scrollHeight);

                  if (data.type === "done" || data.type === "error") {
                    reader.cancel();
                    break;
                  }
                } catch (e) {
                  console.error("無法解析收到的 JSON:", jsonString, e);
                }
              }
              boundary = buffer.indexOf("\n\n");
            }
          }
        } catch (err) {
          console.error("Fetch 請求失敗:", err);
          const $errorEntry = $('<div>').html('<span class="log-error">與伺服器的連線發生錯誤，請檢查後端日誌或網路連線。</span>');
          $logContainer.append($errorEntry);
        } finally {
          $submitBtn.prop('disabled', false).text('執行');
        }
      });


      // 表單提交事件處理
      $('#run-form').on('submit', async function (e) {
        e.preventDefault();

        const $logContainer = $('#log-container');
        const $submitBtn = $('#submit-btn');

        $logContainer.empty();
        $submitBtn.prop('disabled', true).text('執行中...');

        const formData = new FormData(this);

        try {
          const response = await fetch("/run", {
            method: "POST",
            body: formData,
          });

          if (!response.ok) {
            throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              break;
            }

            buffer += decoder.decode(value, { stream: true });

            let boundary = buffer.indexOf("\n\n");
            while (boundary !== -1) {
              const messageString = buffer.substring(0, boundary);
              buffer = buffer.substring(boundary + 2);

              if (messageString.startsWith("data: ")) {
                const jsonString = messageString.substring(6);
                try {
                  const data = JSON.parse(jsonString);

                  const timestamp = new Date().toLocaleTimeString();
                  const logEntryHtml = `
                    <span class="text-muted me-2">[${timestamp}]</span>
                    <span class="log-${data.type}">${data.content}</span>
                  `;

                  const $logEntry = $('<div>').html(logEntryHtml);
                  $logContainer.append($logEntry);
                  $logContainer.scrollTop($logContainer[0].scrollHeight);

                  if (data.type === "done" || data.type === "error") {
                    reader.cancel();
                    break;
                  }
                } catch (e) {
                  console.error("無法解析收到的 JSON:", jsonString, e);
                }
              }
              boundary = buffer.indexOf("\n\n");
            }
          }
        } catch (err) {
          console.error("Fetch 請求失敗:", err);
          const $errorEntry = $('<div>').html('<span class="log-error">與伺服器的連線發生錯誤，請檢查後端日誌或網路連線。</span>');
          $logContainer.append($errorEntry);
        } finally {
          $submitBtn.prop('disabled', false).text('開始執行');
        }
      });
    });
  </script>
</head>

<body>
  <div class="container mt-5 mb-5">
    <header class="text-center mb-4">
      <h1 class="display-5 fw-bold text-primary">Gemini 任務執行器</h1>
      <p class="lead text-muted">請選擇一個執行選項並開始任務。</p>
    </header>

    <main>
      <div class="card p-4 shadow-lg mb-4">
        <h2 class="card-title h4 mb-3">自動化提交工具</h2>
        <div class="mb-3" style="display: flex;justify-content: flex-end;">
          <button class="btn btn-success" id="btnNew">新增</button>
        </div>
        <div class="table-responsive">
          <table id="table1" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>序號</th>
                <th>名稱</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>

        <form id="run-form" class="mt-4">
          <div class="row g-3 align-items-center">
            <div class="col-12 col-md-auto flex-grow-1">
              <label for="run_id_select" class="form-label text-muted mb-0">選擇執行選項:</label>
              <select id="run_id_select" name="run_id" class="form-select">
                {% for option in options %}
                <option value="{{ option.id }}">
                  {{ option.name }} (ID: {{ option.id }}) (option.prompt_files: {{option.prompt_files}})
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12 col-md-auto">
              <button type="submit" id="submit-btn" class="btn btn-primary w-100">開始執行</button>
            </div>
          </div>
        </form>
      </div>

      <div class="card shadow-lg">
        <div class="card-header bg-dark text-white">
          <h5 class="mb-0">執行日誌</h5>
        </div>
        <div class="card-body">
          <div id="log-container">
            <p class="text-secondary">等待任務開始...</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</body>

</html>