<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gemini 任務執行器</title>

  <script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap/bootstrap.min.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap/bootstrap.min.css') }}" />
  <style>
    /* 保持自訂日誌樣式，因為它們是獨特的 */
    #log-container {
      white-space: pre-wrap;
      word-wrap: break-word;
      background-color: #1e293b;
      color: #f1f5f9;
      border-radius: 0.5rem;
      padding: 1rem;
      height: 60vh;
      overflow-y: auto;
      /* font-family: "Courier New", Courier, monospace; */
      text-align: left;
    }

    /* 自訂日誌文字顏色，不與 Bootstrap 衝突 */
    .log-item {
      text-align: left;
    }

    .log-status {
      text-align: left;
      color: #67e8f9;
    }

    .log-error {
      color: #f87171;
      font-weight: bold;
      text-align: left;
    }

    .log-data {
      color: #e5e7eb;
      text-align: left;
    }

    .log-done {
      color: #4ade80;
      font-weight: bold;
      text-align: left;
    }
  </style>

  <script>
    var jsondata_from_server = {{ jsondata | tojson | safe }}

    $(document).ready(function () {
      var data = jsondata_from_server;

      $('#btnNew').click(function () {
        location.href = "/detail?id=''";
      });
      $('#btnHistory').click(function () {
        location.href = "/history?id=''";
      });


      // 初始化 DataTable
      var dataTable = $('#table1').DataTable({
        data: data,
        columns: [
          { data: 'id' },
          {
            data: 'name',
            render: function (data, type, row) {
              const url = `/detail?id=${row.id}`;
              return `<a href="${url}">${data}</a>`;
            }
          },
          {
            data: null,
            render: function (data, type, row) {
              return $("<div/>").append($("<button/>", { class: "btn btn-danger btnDel", text: "刪除" })).html();
            }
          }
        ],
        language: {
          "sProcessing": "處理中...",
          "sLengthMenu": "顯示 _MENU_ 筆結果",
          "sZeroRecords": "沒有符合的結果",
          "sInfo": "顯示第 _START_ 至 _END_ 筆結果，共 _TOTAL_ 筆",
          "sInfoEmpty": "顯示第 0 至 0 筆結果，共 0 筆",
          "sInfoFiltered": "(從 _MAX_ 筆結果中過濾)",
          "sInfoPostFix": "",
          "sSearch": "搜尋:",
          "sUrl": "",
          "oPaginate": {
            "sFirst": "第一頁",
            "sPrevious": "上一頁",
            "sNext": "下一頁",
            "sLast": "最後一頁"
          }
        },
        pageLength: 10,
        order: [[0, 'asc']],
        dom: 't<"text-right"i><"text-center"p>', // 't' 代表 table, 'i' 代表 info, 'p' 代表 pagination
        searching: false,
        paging: true,
        info: true,
        lengthMenu: false,
        autoWidth: true,
        responsive: true,
      });


      //刪除事件
      $("#table1").on('click', ".btnDel", async function (e) {
        if (!confirm("確定要刪除這筆資料嗎？")) {
          return false;
        }
        if (true) {
          return false;
        }

        var id = dataTable.row($(this).parents('tr')).data().id;

        const response = await fetch(`/runbyid?id=${id}`, {
          method: "POST"
        });

        if (!response.ok) {
          throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}`);
        }
      });

    });
  </script>
</head>

<body>
  <div class="container mt-5 mb-5">
    <header class="text-center mb-4">
      <h1 class="display-5 fw-bold text-primary">Gemini 任務執行器</h1>
      <p class="lead text-muted">請選擇一個執行選項並開始任務。</p>
    </header>

    <main>
      <div class="card p-4 shadow-lg mb-4">
        <h2 class="card-title h4 mb-3">自動化提交工具</h2>
        <div class="mb-3" style="display: flex;justify-content: flex-end;">
          <button class="btn btn-success" id="btnNew">新增</button>
        </div>
        <div class="mb-3" style="display: flex;justify-content: flex-end;">
          <button class="btn btn-success" id="btnHistory">看先前生成</button>
        </div>

        <div class="table-responsive">
          <table id="table1" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>序號</th>
                <th>名稱</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</body>

</html>