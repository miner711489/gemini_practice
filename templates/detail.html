<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>詳細內容</title>
  <script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>
  <script src="{{ url_for('static', filename='js/bootstrap/bootstrap.min.js') }}"></script>

  <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.min.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap/bootstrap.min.css') }}" />
  <style>
    #log-container {
      white-space: pre-line;
      word-wrap: break-word;
      background-color: #1e293b;
      color: #f1f5f9;
      border-radius: 0.5rem;
      padding: 1rem;
      height: 90vh;
      overflow-y: auto;
      /* font-family: "Courier New", Courier, monospace; */
      text-align: left;
    }
  </style>

  <script>
    var jsondata_from_server = {{ jsondata | tojson | safe }}
    var token
    $(document).ready(function () {

      $("#btnBack").click(function () {
        location.href = "/";
      });

      // 綁定事件到元素
      $('#btnAdd').on('click', addNewRow);
      $('#btnFileUpdate').on('click', function () {
        $('#fileInput').trigger('click');
      });
      $('#fileInput').on('change', handleFile);

      if ($('#hidId').val() != "") {
        jsondata_from_server.prompts.forEach(element => {
          element.mode = "";
          addNewRow(element);
        });
      }

      $('#btnSave').click(async function () {
        var jsonArray = []
        $("#tablebody tr").each(function () {
          const currentRow = $(this);
          const seqno = currentRow.find("select[name='lstSeqNo']").val();
          const content = currentRow.find("textarea[name='content']").val();
          const type = currentRow.find("input[name='hidType']").val();
          const mode = currentRow.find("input[name='hidMode']").val();

          var jsonObject = {};
          jsonObject.seqno = seqno;
          jsonObject.type = type;
          jsonObject.content = content;
          jsonObject.mode = mode;
          jsonArray.push(jsonObject);
        });

        var data = {}
        data.id = $("#hidId").val();
        data.name = $("#txtName").val();
        data.dir = $("#txtDir").val();
        data.prompts = jsonArray;
        const response = await fetch('/doSave', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data) // 將陣列轉換為 JSON 字串
        });

      });

      $('#btnRun').click(async function () {

        await $('#btnSave').click();

        token = Math.floor(Math.random() * 1000000);
        var id = $('#hidId').val();
        var model = $('#lstModel').val();

        const $logContainer = $('#log-container');
        $logContainer.empty();

        const $submitBtn = $('.btnRun');
        $submitBtn.prop('disabled', true).text('執行中...');

        try {
          const response = await fetch('/runbyid', {
            method: "POST",
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, model: model, token: token })
          });

          if (!response.ok) {
            throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) {
              break;
            }

            buffer += decoder.decode(value, { stream: true });

            let boundary = buffer.indexOf("\n\n");
            while (boundary !== -1) {
              const messageString = buffer.substring(0, boundary);
              buffer = buffer.substring(boundary + 2);

              if (messageString.startsWith("data: ")) {
                const jsonString = messageString.substring(6);
                try {
                  const data = JSON.parse(jsonString);
                  rtnToken = data.token;
                  if (token == rtnToken) {
                    const timestamp = new Date().toLocaleTimeString();
                    const logEntryHtml = `
                    <span class="log-item text-muted">[${timestamp}]</span>
                    <span class="log-${data.type}">${data.content}</span>
                  `;

                    const $logEntry = $('<div>').html(logEntryHtml);
                    $logContainer.append($logEntry);
                    $logContainer.scrollTop($logContainer[0].scrollHeight);
                  }

                  if (data.type === "done" || data.type === "error") {
                    reader.cancel();
                    break;
                  }
                } catch (e) {
                  console.error("無法解析收到的 JSON:", jsonString, e);
                }
              }
              boundary = buffer.indexOf("\n\n");
            }
          }
        } catch (err) {
          console.error("Fetch 請求失敗:", err);
          const $errorEntry = $('<div>').html('<span class="log-error">與伺服器的連線發生錯誤，請檢查後端日誌或網路連線。</span>');
          $logContainer.append($errorEntry);
        } finally {
          $submitBtn.prop('disabled', false).text('執行');
        }
      })

    });

    // 增加一個新行
    function addNewRow(data) {
      const tableBody = $('#tablebody');
      const rowCount = tableBody.find('tr').length + 1;

      // 創建新行
      const newRow = $('<tr></tr>');

      // 序號
      const Cell1 = $('<td></td>').text(rowCount).css('text-align', 'center');

      // 排序
      const sortInput = $('<select></select>').addClass('form-select').attr('name', 'lstSeqNo');
      for (let i = 1; i <= 5; i++) {
        if (data && data.seqno == i) {
          sortInput.append($('<option></option>').val(i).text(i).attr("selected", "selected"));
        } else {
          sortInput.append($('<option></option>').val(i).text(i));
        }
      }

      const Cell2 = $('<td></td>').append(sortInput);

      // 內容
      const nameTextarea = $('<textarea></textarea>').addClass('form-control').attr('name', 'content').attr('rows', 3);
      if (data) {
        nameTextarea.val(data.content);
      }

      //有空這邊條一下
      var type = data.type == "click" ? "text" : data.type;
      const hidType = $("<input/>").attr('type', 'hidden').attr('name', 'hidType').val(type);

      var hidMode;
      if (data) {
        hidMode = $("<input/>").attr('type', 'hidden').attr('name', 'hidMode').val(data.mode);
      } else {
        hidMode = $("<input/>").attr('type', 'hidden').attr('name', 'hidMode').val("n");
      }

      const Cell3 = $('<td></td>').append(nameTextarea).append(hidType).append(hidMode);

      // 動作按鈕
      const adjustButton = $('<button></button>').addClass('btn btn-info btn-sm mb-1 w-100').text('展開');
      const shrinkButton = $('<button></button>').addClass('btn btn-secondary btn-sm mb-1 w-100').text('縮回');
      const deleteButton = $('<button></button>').addClass('btn btn-danger btn-sm w-100').text('刪除');

      const buttonDiv = $('<div></div>').addClass('d-flex flex-column align-items-center');
      buttonDiv.append(adjustButton, shrinkButton, deleteButton);

      const Cell4 = $('<td></td>').append(buttonDiv).addClass('text-center text-nowrap');

      // 將所有單元格添加到新行
      newRow.append(Cell1, Cell2, Cell3, Cell4);

      // 將新行添加到表格主體
      tableBody.append(newRow);

      // 綁定事件監聽器
      adjustButton.on('click', adjustTextareaHeight);
      shrinkButton.on('click', shrinkTextareaHeight);
      deleteButton.on('click', deleteRow);
    }

    // 刪除一個行
    function deleteRow() {
      // 使用 $(this) 取得被點擊的按鈕
      $(this).closest('tr').remove();
      reorderRows();
    }

    // 重新排序序號
    function reorderRows() {
      $('#tablebody tr').each(function (index) {
        $(this).find('td:first').text(index + 1);
      });
    }

    // 調整 textarea 高度
    function adjustTextareaHeight() {
      const textarea = $(this).closest('tr').find('textarea');
      if (textarea.length) {
        textarea.css('height', 'auto').css('height', textarea[0].scrollHeight + 'px');
      }
    }

    // 縮回 textarea 高度
    function shrinkTextareaHeight() {
      const textarea = $(this).closest('tr').find('textarea');
      if (textarea.length) {
        textarea.css('height', '').attr('rows', 3);
      }
    }

    // 處理檔案
    async function handleFile(event) {
      var files = event.target.files[0];
      var reader = new FileReader();
      reader.onloadend = (function (file) {
        return function (evt) {
          var baseSplit = evt.target.result.split(",");
          var base64 = baseSplit[1];
          uploadFile(file, base64);
        };
      })(files);
      reader.readAsDataURL(files);
    }

    async function uploadFile(file, base64) {
      try {
        const response = await fetch('/uploadfile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            "file": file.name,
            "base64": base64
          }),
        });

        // 檢查 HTTP 狀態碼是否成功 (例如 200-299)
        if (!response.ok) {
          // 如果回應不成功，拋出一個錯誤
          throw new Error(`HTTP 錯誤：${response.status}`);
        }

        // await 會暫停程式執行，直到 response.json() 完成並回傳解析後的 JSON
        const result = await response.json();

        console.log('Success:', result);
        alert('資料儲存成功！');

        const jsonobj = {};
        jsonobj.content = file.name;
        jsonobj.type = "file";
        jsonobj.mode = "n"
        addNewRow(jsonobj);
      } catch (error) {
        // 在這裡處理所有錯誤，包括網路問題和 HTTP 狀態碼錯誤
        console.error('Error:', error);
        alert('資料儲存失敗。');
      }
    }
  </script>
</head>

<body>
  <div class="container mt-5 mb-5">
    <div class="card text-center mb-4">
      <input type="hidden" id="hidId" value="{{jsondata.id}}" />
      <div class="row mb-3 mt-3 me-2">
        <div class="col-md-2 d-flex align-items-center justify-content-start">
          <label>名稱</label>
        </div>
        <div class="col-md-10">
          <input type="text" class="form-control" id="txtName" placeholder="請輸入名稱" value="{{jsondata.name}}" />
        </div>
      </div>
      <div class="row mb-3 me-2">
        <div class="col-md-2 d-flex align-items-center justify-content-start">
          <label>路徑</label>
        </div>
        <div class="col-md-10">
          <input type="text" class="form-control" id="txtDir" placeholder="路徑" value="{{jsondata.dir}}" />
        </div>
      </div>
      <div class="row mb-3 me-2">
        <div class="col-md-2 d-flex align-items-center justify-content-start">
          <label>執行模型</label>
        </div>
        <div class="col-md-4">
          <select class="form-select" id="lstModel">
            <option value="gemini-2.5-pro" selected="selected">gemini-2.5-pro</option>
            <option value="gemini-2.5-flash">gemini-2.5-flash</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table id="table1" class="table table-striped table-bordered mb-0">
            <thead>
              <tr>
                <th class="text-center" style="width: 50px;">序</th>
                <th class="text-center" style="width: 10%;">執行序列</th>
                <th class="text-center" style="width: 75%;">內容</th>
                <th class="text-center" style="width: 180px;">
                  <button class="btn btn-primary btn-sm" id="btnAdd">新增</button>
                  <button class="btn btn-success btn-sm" id="btnFileUpdate">檔案上傳</button>
                  <input type="file" id="fileInput" style="display: none;">
                </th>
              </tr>
            </thead>
            <tbody id="tablebody">
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="text-center mt-4">
      <button id="btnBack" class="btn btn-primary">上一頁</button>
      <button id="btnSave" class="btn btn-primary">儲存</button>
      <button id="btnRun" class="btn btn-success">執行</button>
    </div>

    <div class="card shadow-lg mt-4">
      <div class="card-header bg-dark text-white">
        <h5 class="mb-0">執行日誌</h5>
      </div>
      <div class="card-body">
        <div id="log-container">
          <p class="text-secondary">等待任務開始...</p>
        </div>
      </div>
    </div>


  </div>
</body>

</html>